<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIC Ushindi Seme</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #8B0000;
      --primary-dark: #6b0000;
      --primary-light: #a61e1e;
      --accent: #FFD700;
      --accent-glow: #FFA500;
      --success: #10b981;
      --dark: #0f172a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: 'Sora', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 50%, #16213e 100%);
      color: #1f2937;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(139, 0, 0, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
      animation: gradientShift 15s ease infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes gradientShift {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      margin-bottom: 48px;
      animation: slideDown 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .logo {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 900;
      color: white;
      box-shadow: 0 20px 50px rgba(139, 0, 0, 0.3), 0 0 40px rgba(255, 215, 0, 0.2);
      position: relative;
      animation: logoFloat 4s ease-in-out infinite;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    @keyframes logoFloat {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-8px) rotate(2deg); }
    }

    .logo::after {
      content: '‚ú®';
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 28px;
      animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .header-text h1 {
      font-size: clamp(32px, 5vw, 48px);
      font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, var(--accent) 50%, #fff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -1px;
      margin-bottom: 12px;
    }

    .header-text p {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      flex: 1;
      margin-bottom: 40px;
    }

    .card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      padding: 40px;
      backdrop-filter: blur(20px);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      animation: cardAppear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
    }

    @keyframes cardAppear {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card:nth-child(1) { animation-delay: 0.2s; }
    .card:nth-child(2) { animation-delay: 0.3s; }

    .card:hover {
      border-color: rgba(255, 215, 0, 0.3);
      background: rgba(255, 255, 255, 0.11);
      transform: translateY(-8px);
      box-shadow: 0 35px 70px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15), 0 0 40px rgba(255, 215, 0, 0.1);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 10px 25px rgba(139, 0, 0, 0.3);
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 10px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .participant-input-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .participant-input {
      width: 100%;
      padding: 14px 80px 14px 18px;
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-family: 'Sora', system-ui, sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .participant-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .participant-input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2), inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .add-participant-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .add-participant-btn:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 4px 12px rgba(139, 0, 0, 0.4);
    }

    .participants-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .participants-tags::-webkit-scrollbar {
      width: 6px;
    }

    .participants-tags::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .participants-tags::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 10px;
    }

    .participant-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(139, 0, 0, 0.4), rgba(139, 0, 0, 0.2));
      border: 1px solid rgba(255, 215, 0, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      animation: tagAppear 0.3s ease;
    }

    @keyframes tagAppear {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .participant-tag .remove-tag {
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .participant-tag .remove-tag:hover {
      opacity: 1;
    }

    .participant-tag .ticket-count {
      background: rgba(255, 215, 0, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--accent);
    }

    input[type="number"], select {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-family: 'Sora', system-ui, sans-serif;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2), inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .form-group { margin-bottom: 20px; }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .info-text {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 8px;
      line-height: 1.5;
    }

    .info-text code {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 28px;
    }

    button {
      padding: 16px 24px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      font-family: 'Sora', system-ui, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-transform: uppercase;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 12px 30px rgba(139, 0, 0, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(139, 0, 0, 0.5), 0 0 30px rgba(255, 215, 0, 0.2);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1.5px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--accent);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.1);
    }

    button:active { transform: translateY(-2px); }
    button:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .stage {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
      border: 2px solid rgba(255, 215, 0, 0.2);
      border-radius: 24px;
      padding: 60px 40px;
      text-align: center;
      min-height: 520px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      transition: all 0.5s ease;
    }

    .stage.celebrating {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 165, 0, 0.05) 100%);
      box-shadow: 0 0 60px rgba(255, 215, 0, 0.3), 0 20px 50px rgba(0, 0, 0, 0.4);
    }

    .wheel-container {
      position: relative;
      width: 320px;
      height: 320px;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      box-shadow: 
        0 20px 60px rgba(139, 0, 0, 0.5),
        0 0 40px rgba(255, 215, 0, 0.4),
        inset 0 0 30px rgba(0, 0, 0, 0.2);
      border: 5px solid rgba(255, 255, 255, 0.15);
      position: relative;
      transition: transform 0.1s linear;
      overflow: hidden;
    }

    .wheel-segment {
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
    }

    .wheel-segment canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
    }

    .wheel-segment-text {
      position: absolute;
      color: white;
      font-weight: 700;
      font-size: 13px;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.8);
      white-space: nowrap;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      transform-origin: center;
      left: 50%;
      top: 50%;
      pointer-events: none;
    }

    .wheel.spinning {
      animation: none;
    }

    .wheel-center {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #4a4a4a, #2a2a2a);
      border: 4px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      z-index: 10;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .wheel-center-star {
      width: 60%;
      height: 60%;
      background: linear-gradient(135deg, var(--accent), var(--accent-glow));
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      animation: starPulse 2s ease-in-out infinite;
    }

    @keyframes starPulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      50% { transform: scale(1.1) rotate(180deg); }
    }

    .wheel-pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-top: 30px solid var(--accent);
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      z-index: 20;
      animation: pointerGlow 1.5s ease-in-out infinite;
    }

    @keyframes pointerGlow {
      0%, 100% { filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3)); }
      50% { filter: drop-shadow(0 6px 20px rgba(255, 215, 0, 0.6)); }
    }

    .name-display {
      font-size: clamp(28px, 5vw, 48px);
      font-weight: 900;
      color: var(--accent);
      min-height: 56px;
      margin: 20px 0;
      letter-spacing: -1px;
      animation: nameReveal 0.5s ease;
    }

    @keyframes nameReveal {
      0% { opacity: 0; transform: scale(0.8) translateY(-20px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .stage-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      line-height: 1.6;
      margin-top: 16px;
    }

    .results-container {
      background: rgba(255, 255, 255, 0.04);
      border: 1.5px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 24px;
      margin-top: 24px;
      max-height: 300px;
      overflow-y: auto;
      backdrop-filter: blur(15px);
    }

    .results-container::-webkit-scrollbar {
      width: 8px;
    }

    .results-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .results-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border-radius: 10px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-left: 4px solid var(--accent);
      border-radius: 10px;
      transition: all 0.3s ease;
      animation: resultSlide 0.5s ease backwards;
    }

    @keyframes resultSlide {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .result-item:nth-child(1) { animation-delay: 0.1s; border-left-color: #FFD700; }
    .result-item:nth-child(2) { animation-delay: 0.2s; border-left-color: #C0C0C0; }
    .result-item:nth-child(3) { animation-delay: 0.3s; border-left-color: #CD7F32; }

    .result-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(4px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.15);
    }

    .result-item.winner {
      background: rgba(255, 215, 0, 0.1);
      border-left-width: 6px;
    }

    .result-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .result-medal { font-size: 24px; min-width: 32px; }

    .result-text h4 {
      font-size: 15px;
      font-weight: 700;
      color: white;
      margin-bottom: 4px;
    }

    .result-text p {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
    }

    .result-rank {
      font-size: 18px;
      font-weight: 900;
      color: var(--accent);
      min-width: 40px;
      text-align: right;
    }

    .confetti {
      position: fixed;
      width: 12px;
      height: 12px;
      background: var(--accent);
      animation: confettiFall 3s ease-out forwards;
      z-index: 2000;
      pointer-events: none;
    }

    @keyframes confettiFall {
      0% { opacity: 1; transform: translateY(0) translateX(0) rotate(0deg); }
      100% { opacity: 0; transform: translateY(100vh) translateX(100px) rotate(720deg); }
    }

    .status-msg {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 16px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 15px 40px rgba(139, 0, 0, 0.4);
      animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 2001;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .countdown {
      font-size: 18px;
      color: var(--accent);
      font-weight: 700;
      margin: 10px 0;
      min-height: 25px;
    }

    @media (max-width: 1024px) {
      .main-grid { grid-template-columns: 1fr; gap: 24px; }
      .form-row { grid-template-columns: 1fr; }
      .container { padding: 30px 16px; }
      .card { padding: 32px; }
      .stage { min-height: 450px; }
      
      .card:nth-child(2) {
        display: none;
      }
      
      .card:nth-child(2).show-on-mobile {
        display: block;
        animation: slideInMobile 0.5s ease;
      }
    }

    @keyframes slideInMobile {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 640px) {
      .logo-wrapper { flex-direction: column; gap: 12px; }
      .header-text h1 { font-size: 28px; }
      .button-group { grid-template-columns: 1fr; }
      .wheel-container { width: 260px; height: 260px; }
      .wheel-center { width: 60px; height: 60px; }
      .stage { padding: 40px 24px; min-height: 350px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-wrapper">
        <div class="logo">AIC</div>
        <div class="header-text">
          <h1>üèÜ Ushindi Seme Prize Draw</h1>
          <p>HONEST ‚Ä¢ TRANSPARENT ‚Ä¢ RAFFLE</p>
        </div>
      </div>
    </header>

    <div class="main-grid">
      <div class="card">
        <div class="card-title">
          <div class="card-icon">‚öôÔ∏è</div>
          Setup & Controls
        </div>

        <div class="form-group">
          <label>üë• Add Participants</label>
          <div class="participant-input-wrapper">
            <input type="text" id="participantInput" class="participant-input" placeholder="Enter name or Name:count">
            <button class="add-participant-btn" id="addParticipantBtn">+ Add</button>
          </div>
          <div class="participants-tags" id="participantsTags"></div>
          <div class="info-text">üí° Format: <code>Name</code> or <code>Name:count</code> for multiple tickets. Press Enter or click Add.</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Mode</label>
            <select id="mode">
              <option value="raffle">üéüÔ∏è Raffle Draw</option>
              <option value="score">üèÜ Score Assignment</option>
            </select>
          </div>
          <div class="form-group">
            <label>Number of Winners</label>
            <input id="count" type="number" min="1" value="3" />
          </div>
        </div>

        <div class="form-group">
          <label>Draw Duration (seconds)</label>
          <input id="drawDuration" type="number" min="2" max="10" value="5" />
          <div class="info-text">How long the draw animation will run before revealing winners</div>
        </div>

        <div class="button-group" style="grid-template-columns: 1fr;">
          <button id="startBtn" class="btn-primary" style="grid-column: 1/-1;">üé≤ START DRAW</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 16px;">
          <button id="clearBtn" class="btn-secondary">üóëÔ∏è Clear</button>
        </div>
      </div>

      <div class="card" id="displayCard">
        <div class="card-title">
          <div class="card-icon">üéØ</div>
          Live Draw Display
        </div>

        <div class="stage" id="stage">
          <div class="wheel-container">
            <div class="wheel-pointer"></div>
            <div class="wheel" id="wheel">
              <div class="wheel-center">
                <div class="wheel-center-star"></div>
              </div>
            </div>
          </div>
          <div class="countdown" id="countdown"></div>
          <div class="name-display" id="flash">Ready to Draw!</div>
          <div class="stage-subtitle" id="sub">Click "START DRAW" to begin</div>
        </div>

        <div class="results-container" id="results"></div>
        <div id="exportButtonContainer" style="display: none; margin-top: 16px;">
          <button id="exportBtn" class="btn-primary" style="width: 100%;">üìä Export Results to Excel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function rngInt(max) {
      const a = new Uint32Array(1);
      window.crypto.getRandomValues(a);
      return a[0] % max;
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = rngInt(i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    const participantInput = document.getElementById('participantInput');
    const addParticipantBtn = document.getElementById('addParticipantBtn');
    const participantsTags = document.getElementById('participantsTags');
    const modeEl = document.getElementById('mode');
    const countEl = document.getElementById('count');
    const drawDurationEl = document.getElementById('drawDuration');
    const startBtn = document.getElementById('startBtn');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const flashEl = document.getElementById('flash');
    const subEl = document.getElementById('sub');
    const countdownEl = document.getElementById('countdown');
    const wheel = document.getElementById('wheel');
    const resultsEl = document.getElementById('results');
    const exportButtonContainer = document.getElementById('exportButtonContainer');
    const stage = document.getElementById('stage');
    const displayCard = document.getElementById('displayCard');

    let spinInterval = null;
    let currentPool = [];
    let lastWinners = [];
    let participantsList = [];

    function addParticipant() {
      const text = participantInput.value.trim();
      if (!text) return;

      let name = text, weight = 1;
      if (text.includes(':')) {
        [name, weight] = text.split(':');
        weight = Math.max(1, parseInt(weight) || 1);
        name = name.trim();
      }

      if (!name) return;

      participantsList.push({ name, weight });
      renderParticipantTags();
      participantInput.value = '';
    }

    function removeParticipant(index) {
      participantsList.splice(index, 1);
      renderParticipantTags();
    }

    function renderParticipantTags() {
      participantsTags.innerHTML = '';
      participantsList.forEach((p, idx) => {
        const tag = document.createElement('div');
        tag.className = 'participant-tag';
        tag.innerHTML = `
          <span>${p.name}</span>
          ${p.weight > 1 ? `<span class="ticket-count">x${p.weight}</span>` : ''}
          <span class="remove-tag" onclick="removeParticipant(${idx})">√ó</span>
        `;
        participantsTags.appendChild(tag);
      });
    }

    function parseParticipants() {
      const list = [];
      let ticketId = 1;
      for (const p of participantsList) {
        for (let i = 0; i < p.weight; i++) {
          list.push({ name: p.name, ticket: `${ticketId++}` });
        }
      }
      return list;
    }

    function createWheelSegments(participants) {
      wheel.innerHTML = '';
      
      const centerEl = document.createElement('div');
      centerEl.className = 'wheel-center';
      centerEl.innerHTML = '<div class="wheel-center-star"></div>';
      wheel.appendChild(centerEl);

      if (participants.length === 0) return;

      const uniqueNames = [...new Set(participants.map(p => p.name))];
      const colors = ['#8B0000', '#FFD700', '#6b0000', '#FFA500', '#a61e1e', '#4ECDC4', '#FF6B6B', '#95E1D3'];
      const anglePerSegment = 360 / uniqueNames.length;

      uniqueNames.forEach((name, idx) => {
        const segment = document.createElement('div');
        segment.className = 'wheel-segment';
        const color = colors[idx % colors.length];
        segment.style.position = 'absolute';
        segment.style.width = '100%';
        segment.style.height = '100%';
        segment.style.left = '0';
        segment.style.top = '0';
        
        const canvas = document.createElement('canvas');
        canvas.width = 320;
        canvas.height = 320;
        canvas.style.position = 'absolute';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.style.left = '0';
        canvas.style.top = '0';
        
        const ctx = canvas.getContext('2d');
        const centerX = 160;
        const centerY = 160;
        const radius = 160;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        const startAngle = (idx * anglePerSegment - 90) * Math.PI / 180;
        const endAngle = ((idx + 1) * anglePerSegment - 90) * Math.PI / 180;
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
        
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        segment.appendChild(canvas);
        
        const text = document.createElement('div');
        text.className = 'wheel-segment-text';
        text.textContent = name.length > 12 ? name.substring(0, 10) + '...' : name;
        
        const middleAngle = (startAngle + endAngle) / 2;
        const textDistance = 100;
        const textX = Math.cos(middleAngle) * textDistance;
        const textY = Math.sin(middleAngle) * textDistance;
        const textRotation = (middleAngle * 180 / Math.PI + 90);
        
        text.style.transform = `translate(-50%, -50%) translate(${textX}px, ${textY}px) rotate(${textRotation}deg)`;
        
        segment.appendChild(text);
        wheel.appendChild(segment);
      });

      wheel.appendChild(centerEl);
    }

    function showMessage(msg) {
      const existing = document.querySelector('.status-msg');
      if (existing) existing.remove();
      const div = document.createElement('div');
      div.className = 'status-msg';
      div.innerHTML = `<span>‚ú®</span> ${msg}`;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    async function startSpin() {
      if (participantsList.length === 0) { 
        showMessage('‚ö†Ô∏è Add participants first!'); 
        return; 
      }
      
      currentPool = parseParticipants();
      if (currentPool.length === 0) { 
        showMessage('‚ö†Ô∏è No valid entries!'); 
        return; 
      }

      // Auto-scroll to show the live draw display on mobile
      if (window.innerWidth <= 1024) {
        displayCard.classList.add('show-on-mobile');
        setTimeout(() => {
          displayCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      }

      createWheelSegments(currentPool);
      lastWinners = [];
      startBtn.disabled = true;
      wheel.classList.add('spinning');
      stage.classList.remove('celebrating');
      exportButtonContainer.style.display = 'none';
      
      const drawDuration = parseInt(drawDurationEl.value) * 1000;
      let timeLeft = drawDuration / 1000;
      
      const countdownInterval = setInterval(() => {
        countdownEl.textContent = `Revealing in ${timeLeft} seconds...`;
        timeLeft--;
        
        if (timeLeft < 0) {
          clearInterval(countdownInterval);
          countdownEl.textContent = '';
        }
      }, 1000);

      const desired = Math.max(1, parseInt(countEl.value) || 1);
      const winners = drawRaffleWinners(desired);
      const winnerName = winners[0].name;
      
      const uniqueNames = [...new Set(currentPool.map(p => p.name))];
      const winnerIndex = uniqueNames.indexOf(winnerName);
      const anglePerSegment = 360 / uniqueNames.length;
      
      const segmentCenterAngle = winnerIndex * anglePerSegment + anglePerSegment / 2;
      const targetAngle = 360 - segmentCenterAngle;
      
      const fullRotations = 5 + Math.floor(Math.random() * 3);
      const finalRotation = (fullRotations * 360) + targetAngle;

      let rotation = 0;
      let currentSpeed = 40;
      const normalPhase = drawDuration - 2000;
      
      spinInterval = setInterval(() => {
        const idx = rngInt(currentPool.length);
        flashEl.style.animation = 'none';
        setTimeout(() => { flashEl.style.animation = 'nameReveal 0.5s ease'; }, 10);
        flashEl.textContent = currentPool[idx].name;
        
        rotation += currentSpeed;
        wheel.style.transform = `rotate(${rotation}deg)`;
      }, 50);

      setTimeout(() => {
        clearInterval(spinInterval);
        
        const remainingTime = 2000;
        const remainingDistance = finalRotation - rotation;
        const steps = 20;
        const stepTime = remainingTime / steps;
        let currentStep = 0;
        
        const decelerationInterval = setInterval(() => {
          currentStep++;
          const progress = currentStep / steps;
          const easeOut = 1 - Math.pow(1 - progress, 3);
          rotation = (finalRotation - remainingDistance) + (remainingDistance * easeOut);
          
          wheel.style.transform = `rotate(${rotation}deg)`;
          
          if (currentStep % 2 === 0) {
            const currentAngle = (rotation % 360 + 360) % 360;
            const currentSegmentIndex = Math.floor((360 - currentAngle + anglePerSegment / 2) / anglePerSegment) % uniqueNames.length;
            flashEl.textContent = uniqueNames[currentSegmentIndex];
          }
          
          if (currentStep >= steps) {
            clearInterval(decelerationInterval);
            clearInterval(countdownInterval);
            countdownEl.textContent = '';
            
            wheel.style.transform = `rotate(${finalRotation}deg)`;
            flashEl.textContent = winnerName;
            
            wheel.classList.remove('spinning');
            startBtn.disabled = false;

            showWinners(winners, 'raffle');
            
            if (winners.length > 0) celebrateWinner();
          }
        }, stepTime);
        
      }, normalPhase);
    }

    function drawRaffleWinners(n) {
      const poolCopy = currentPool.slice();
      shuffleArray(poolCopy);
      const winners = [];
      const seen = new Set();
      
      for (let i = 0; i < poolCopy.length && winners.length < n; i++) {
        const candidate = poolCopy[i];
        if (!seen.has(candidate.name)) {
          winners.push(candidate);
          seen.add(candidate.name);
        }
      }
      
      if (winners.length < n) {
        const remaining = poolCopy.filter(p => !winners.includes(p));
        for (let i = 0; i < remaining.length && winners.length < n; i++) {
          winners.push(remaining[i]);
        }
      }
      
      return winners;
    }

    function showWinners(items, mode) {
      resultsEl.innerHTML = '';
      lastWinners = items;
      
      items.forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = 'result-item winner';
        
        const medals = ['ü•á', 'ü•à', 'ü•â', 'üéÅ'];
        const medal = medals[idx] || 'üéÅ';
        div.innerHTML = `
          <div class="result-info">
            <div class="result-medal">${medal}</div>
            <div class="result-text">
              <h4>${it.name}</h4>
              <p>Ticket #${it.ticket}</p>
            </div>
          </div>
          <div class="result-rank">#${idx + 1} WINNER</div>
        `;
        
        resultsEl.appendChild(div);
      });

      if (items.length > 0) {
        const firstItem = items[0];
        flashEl.textContent = firstItem.name;
        subEl.textContent = `üéâ ${firstItem.name} WINS! (${items.length} winner${items.length > 1 ? 's' : ''})`;
        exportButtonContainer.style.display = 'block';
      }
    }

    function celebrateWinner() {
      stage.classList.add('celebrating');
      
      for (let i = 0; i < 60; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = ['#FFD700', '#FFA500', '#FF6B6B', '#4ECDC4', '#95E1D3'][Math.floor(Math.random() * 5)];
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 20);
      }

      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = 800;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + 0.5);
      } catch (e) {}
    }

    function clearResults() {
      participantsList = [];
      participantInput.value = '';
      renderParticipantTags();
      resultsEl.innerHTML = '';
      flashEl.textContent = 'Ready to Draw!';
      subEl.textContent = 'Click "START DRAW" to begin';
      countdownEl.textContent = '';
      lastWinners = [];
      exportButtonContainer.style.display = 'none';
      if (spinInterval) { clearInterval(spinInterval); spinInterval = null; }
      startBtn.disabled = false;
      wheel.classList.remove('spinning');
      stage.classList.remove('celebrating');
      wheel.innerHTML = '';
      createWheelSegments([]);
      wheel.style.transform = 'rotate(0deg)';
      
      if (window.innerWidth <= 1024) {
        displayCard.classList.remove('show-on-mobile');
      }
    }

    function exportToExcel() {
      if (participantsList.length === 0) { 
        showMessage('Nothing to export!'); 
        return; 
      }
      
      const allParticipants = parseParticipants();
      const winnerNames = new Set(lastWinners.map(w => w.name));
      
      const data = [];
      data.push(['AIC USHINDI SEME PRIZE DRAW RESULTS']);
      data.push(['Date: ' + new Date().toLocaleDateString()]);
      data.push(['Time: ' + new Date().toLocaleTimeString()]);
      data.push([]);
      data.push(['Name', 'Ticket Number', 'Status', 'Winner Rank']);
      
      const winnerMap = new Map();
      lastWinners.forEach((w, idx) => {
        winnerMap.set(w.name, idx + 1);
      });
      
      allParticipants.forEach(p => {
        const isWinner = winnerNames.has(p.name);
        const rank = isWinner ? `Winner #${winnerMap.get(p.name)}` : '';
        const status = isWinner ? 'WINNER' : 'Participant';
        data.push([p.name, p.ticket, status, rank]);
      });
      
      data.push([]);
      data.push(['SUMMARY']);
      data.push(['Total Participants:', new Set(allParticipants.map(p => p.name)).size]);
      data.push(['Total Tickets:', allParticipants.length]);
      data.push(['Number of Winners:', lastWinners.length]);
      
      const worksheet = XLSX.utils.aoa_to_sheet(data);
      
      worksheet['!cols'] = [
        { wch: 25 },
        { wch: 15 },
        { wch: 15 },
        { wch: 15 }
      ];
      
      const range = XLSX.utils.decode_range(worksheet['!ref']);
      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
          if (!worksheet[cellAddress]) continue;
          
          if (R === 0 || R === 1 || R === 2 || R === 4) {
            worksheet[cellAddress].s = {
              font: { bold: true },
              alignment: { horizontal: 'center' }
            };
          }
          
          if (worksheet[cellAddress].v === 'WINNER') {
            worksheet[cellAddress].s = {
              font: { bold: true, color: { rgb: 'FFD700' } },
              fill: { fgColor: { rgb: '8B0000' } }
            };
          }
        }
      }
      
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Draw Results');
      
      const timestamp = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(workbook, `AIC_Ushindi_Seme_Results_${timestamp}.xlsx`);
      
      showMessage('‚úÖ Excel file exported successfully!');
    }

    addParticipantBtn.addEventListener('click', addParticipant);
    participantInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addParticipant();
    });
    startBtn.addEventListener('click', startSpin);
    clearBtn.addEventListener('click', clearResults);
    exportBtn.addEventListener('click', exportToExcel);

    window.removeParticipant = removeParticipant;

    createWheelSegments([]);
  </script>
</body>
</html>